var Notiffi=function(){"use strict";async function t(t,e){const n=new URLSearchParams;n.append("id",t),n.append("channel",e);try{const e=await fetch("/notif",{method:"DELETE",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n.toString()});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);document.querySelector(`[data-notif-id="${t}"]`).remove();return(await e.json()).store}catch(t){console.error("Erreur lors de la suppression :",t)}}async function e(t){const e=new URLSearchParams;t.forEach((t=>e.append("del_notif[]",t))),e.append("delete_all","Tout supprimer");try{const t=await fetch("/profile?mode=editprofile&page_profil=notifications",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e.toString()});if(!t.ok)throw new Error(`HTTP error! status ${t.status}`);return!0}catch(t){console.error("Erreur lors de la suppression :",t)}}async function n(t){const e=new URLSearchParams;t.forEach((t=>e.append("id[]",t)));try{const t=await fetch("/notif",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e.toString()});if(!t.ok)throw new Error(`HTTP error! status ${t.status}`)}catch{console.error("Erreur lors de la suppression :",err)}}async function o(t){const{id:e,name:n}=t;if("Anonymous"===n)return{avatar:"",color:""};if(Notiffi.users[e])return Notiffi.users[e];try{const t=await fetch(`/u${e}`);if(!t.ok)throw new Error(`Failed to fetch: ${t.statusText}`);const o=await t.text(),i=(new DOMParser).parseFromString(o,"text/html"),r=i.querySelector(`img[alt="${n}"]`),a=r?`<img loading="lazy" src=${r.src} />`:"",s=i.querySelector('span[style^="color:#"]'),c=s?s.style.color:"";return Notiffi.users[e]={avatar:a,color:c},Notiffi.users[e]}catch(t){return console.error(`Error fetching avatar for user ${n}`,t),null}}function i(t,e){const{from:n}=t.text;return Toolbar.compileNotif(t).replace(new RegExp(`(<a href="/u${n.id}")`,"g"),`$1 style="color: ${e}"`)}function r(t){return`<img src="${t.text.award.award_image}" />`}function a({button:t,panel:e}){const n=document.querySelector(t),o=document.querySelector(e);n&&o?(n.addEventListener("click",(function(){n.classList.toggle("active"),o.classList.toggle("open")})),document.addEventListener("click",(function(t){n.contains(t.target)||o.contains(t.target)||!o.classList.contains("open")||(n.classList.remove("active"),o.classList.remove("open"))}))):console.error("Notiffi popup : button or panel selector not found.")}const s={};function c(t,e,n=0){if("string"!=typeof t||"function"!=typeof e)throw new TypeError("Invalid arguments: 'name' must be a string and 'fn' must be a function.");s[t]=s[t]||[],s[t].push([e,n]),s[t].sort(((t,e)=>t[1]-e[1]))}function l(t,e,...n){return(s[t]||[]).reduce(((t,[e])=>{const o=e(t,...n);return void 0!==o?o:""}),e)}function u(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}c("token",((t,e,n)=>{const o=t.split(".");let i=e;for(let t=0;t<o.length;t++){if(!Object.prototype.hasOwnProperty.call(i,o[t]))return"";i=i[o[t]]}return i}));const f=_userdata,d={user:{name:f.username,logged_in:Boolean(f.session_logged_in),level:f.user_level,id:f.user_id,posts:f.user_posts,avatar:f.avatar,avatar_link:f.avatar_link,group_color:f.groupcolor}},p=t=>Object.assign({$store:d},t);let m=0;const h=new Map,y=new Map;function g(t,e){if(y.has(t))return y.get(t);const n=function(t,e){const n=new RegExp(`${u(e.start)}\\s*([!\\/]?)\\s*(${e.path})\\s*${u(e.end)}`,"gi");let o,i=[],r=0;for(;null!==(o=n.exec(t));)o.index>r&&i.push({type:"static",value:t.slice(r,o.index)}),i.push({type:"token",flag:o[1],value:o[2]}),r=n.lastIndex;return r<t.length&&i.push({type:"static",value:t.slice(r)}),i}(t,e);return y.set(t,n),n}function b(t,e,n){const o=g(t,n);let i="",r=0;for(;r<o.length;){const a=o[r];if("static"===a.type)i+=a.value,r++;else if("token"===a.type){if("/"===a.flag){r++;continue}let s,c=[],u=r+1,f=!1;for(;u<o.length;){const t=o[u];if("token"===t.type&&"/"===t.flag&&t.value===a.value){f=!0;break}c.push(t),u++}try{s=l("token",a.value,e,t)}catch(t){console.warn(t.message),s=""}if(f){const t=c.map((t=>"static"===t.type?t.value:`${n.start}${t.flag?t.flag:""}${t.value}${n.end}`)).join("");if("boolean"==typeof s)i+=s?b(t,e,n):"";else if("object"==typeof s){for(const e in s)if(s.hasOwnProperty(e)){const o=Object.assign({},s[e],{_key:e,_value:s[e]});let r=b(t,o,n).trim();const a="potion_"+m++;h.set(a,o),r=r.replace(/^\s*<([a-zA-Z0-9-]+)/,`<$1 data-potion-key="${a}"`),i+=r}}else i+=s;r=u+1}else i+=s,r++}}return i}const w=h;function v(t,e){[...t.attributes].filter((t=>t.name.startsWith("@"))).forEach((n=>{const o=n.name.slice(1).split("."),i=o[0],r=o.slice(1),a=n.value.match(/^(\w+)(?:\((.*)\))?$/);if(!a)return void console.warn("Potion: impossible de parser l'expression de l'événement:",n.value);const s=a[1],c=a[2]||"",l=function(t,e){let n=t;for(;n&&n!==document.body;){const t=n.getAttribute("data-potion-key");if(t){const e=w.get(t);if(void 0!==e)return e}n=n.parentElement}return e}(t,e),u=c?c.split(",").map((t=>function(t,e){if("true"===t)return!0;if("false"===t)return!1;if(!isNaN(t))return Number(t);const n=t.match(/^["'](.*)["']$/);return n?n[1]:e[t]||t}(t.trim(),l))):[],f="function"==typeof l[s]?l[s]:"function"==typeof e[s]?e[s]:null;if("function"==typeof f){t.removeEventListener(i,t._boundEvents?.[i]);const n=t=>{if(r.includes("self")&&t.target!==t.currentTarget)return;r.includes("prevent")&&t.preventDefault(),r.includes("stop")&&t.stopPropagation(),r.includes("stopImmediate")&&t.stopImmediatePropagation&&t.stopImmediatePropagation();const n={...e,...l};f.call(n,t,...u)};t._boundEvents={...t._boundEvents,[i]:n};const o={};r.includes("capture")&&(o.capture=!0),r.includes("once")&&(o.once=!0),r.includes("passive")&&(o.passive=!0),t.addEventListener(i,n,o)}else console.warn(`Potion: function '${s}' not found in local context or data.`);t.removeAttribute(n.name)}))}function _(t,e){if(t.nodeType===e.nodeType&&t.nodeName===e.nodeName)if(t.nodeType!==Node.TEXT_NODE){if(t.nodeType===Node.ELEMENT_NODE){Array.from(e.attributes).forEach((e=>{e.name.startsWith("@")||e.name.startsWith("#")||t.getAttribute(e.name)!==e.value&&t.setAttribute(e.name,e.value)})),Array.from(t.attributes).forEach((n=>{n.name.startsWith("@")||n.name.startsWith("#")||e.hasAttribute(n.name)||t.removeAttribute(n.name)}));const n=Array.from(t.childNodes),o=Array.from(e.childNodes),i=Math.max(n.length,o.length);for(let e=0;e<i;e++)e>=n.length?t.appendChild(o[e].cloneNode(!0)):e>=o.length?t.removeChild(n[e]):_(n[e],o[e])}}else t.textContent!==e.textContent&&(t.textContent=e.textContent);else t.parentNode.replaceChild(e.cloneNode(!0),t)}function E(t,e){const n=t.tagName.toLowerCase(),o=(new DOMParser).parseFromString(`<${n}>${e}</${n}>`,"text/html").body.firstChild;[...t.attributes].forEach((t=>{o.setAttribute(t.name,t.value)})),_(t,o)}const $=new WeakMap;function N(t,e,n=1/0,o=0){if("object"!=typeof t||null===t)return t;if(o>=n)return t;if($.has(t))return $.get(t);const i=new Proxy(t,{get:(t,i)=>N(Reflect.get(t,i),e,n,o+1),set(t,n,o){const i=t[n],r=Reflect.set(t,n,o);return i!==o&&e(),r}});return $.set(t,i),i}let T={},x=!1;let S={start:"[",end:"]",path:"[a-z0-9_$][\\.a-z0-9_]*",type:"template/potion",attr:"data-name",tag:"div",class:""};function A(t,e){return e=p(e),x||(x=!0,l("init",t,e)),(t=l("templateBefore",t,e)).includes(S.start)||(t=T[t]||t),(t=l("template",t,e))&&void 0!==e&&(t=b(t,e,S)),l("templateAfter",t,e)}function k(t,e,n){n={...S,...n},e=p(e);const o=A(t.innerHTML,e);let i;var r;return i=!n.tag||(r=n.tag,document.createElement(r)instanceof HTMLUnknownElement)?document.createElement(S.tag):document.createElement(n.tag),i.innerHTML=o,[...t.attributes].forEach((t=>{"type"!==t.name&&i.setAttribute(t.name,t.value)})),n.class&&i.classList.add(...n.class.split(" ")),e.$root=i,function(t,e){const n={};t.querySelectorAll("[\\#ref]").forEach((t=>{const e=t.getAttribute("#ref");e&&(n[e]=t,t.removeAttribute("#ref"))})),e.$refs=Object.assign({},e.$refs,n)}(i,e),v(i,e),i.querySelectorAll("*").forEach((t=>v(t,e))),t.parentNode.replaceChild(i,t),i}function L(t,e){return A(t,e)}"undefined"!=typeof window&&document.querySelectorAll(`template[type="${S.type}"]`).forEach((t=>{const e=t.getAttribute(S.attr);T[e]=t.innerHTML})),L.sync=function(t,e,n){const o=document.querySelector(`template[data-name='${t}']`);if(!o)throw new Error(`Potion: template with name '${t}' not found`);e=p(e);const i=o.innerHTML;let r=()=>{};const a=N(e,(()=>{r()})),s=k(o,a,n);return r=()=>{const t=A(i,a);E(s,t),v(s,a),s.querySelectorAll("*").forEach((t=>v(t,a)))},a},L.render=function(t,e,n){const o=document.querySelector(`template[data-name='${t}']`);if(!o)throw new Error(`Potion: template with name '${t}' not found`);return k(o,e,n)},L.addFilter=c,L.applyFilter=l;const P={store:[],unread:null,..._userdata.session_logged_in&&{syncStore:L.sync("all_notifs",{notifs:[],isEmpty:!0,text:"Aucune notification"})}&&{syncUnread:L.sync("unread_notifs",{count:""})},refresh:0,users:{},disableIcon:!1,type:{0:{name:"private_msg",icon:'<i class="bi bi-envelope-fill"></i>'},1:{name:"notif_report",icon:'<i class="bi bi-flag-fill"></i>'},2:{name:"friend_request",icon:'<i class="bi bi-person-fill-add"></i>'},3:{name:"group_req",icon:'<i class="bi bi-people-fill"></i>'},4:{name:"friend_conv",icon:'<i class="bi bi-people-fill"></i>'},5:{name:"wall_msg",icon:'<i class="bi bi-chat-fill"></i>'},6:{name:"abuse",icon:'<i class="bi bi-flag-fill"></i>'},7:{name:"topic_watch",icon:'<i class="bi bi-chat-fill"></i>'},8:{name:"mention",icon:'<i class="bi bi-at"></i>'},9:{name:"hashtag",icon:'<i class="bi bi-hash"></i>'},10:{name:"advert",icon:'<i class="bi bi-flag-fill"></i>'},11:{name:"like",icon:'<i class="bi bi-heart-fill"></i>'},12:{name:"dislike",icon:'<i class="bi bi-heart-half"></i>'},13:{name:"forum_watch",icon:'<i class="bi bi-chat-left-fill"></i>'},14:{name:"new_award",icon:'<i class="bi bi-star-fill"></i>'},15:{name:"follower_new_topic",icon:'<i class="bi bi-chat-left-fill"></i>'},16:{name:"follower_new_post",icon:'<i class="bi bi-chat-fill"></i>'}},init:async function(t={}){if(!_userdata.session_logged_in)return;if(a({button:t.button||"#notiffi_button",panel:t.panel||"#notiffi_panel"}),1==t.disableIcon&&(this.disableIcon=!0),t.icons)for(const e in t.icons)this.type[e]&&(this.type[e].icon=t.icons[e]);this.manageNotifications(),Toolbar=this.interceptMethodCalls(Toolbar,(async e=>{if("refresh"===e){this.refresh++;const e=await async function(){try{const t=await fetch("/notif");if(!t.ok)throw new Error(`Failed to fetch: ${t.status} ${t.statusText}`);return await t.json()}catch(t){console.error("Error fetching notifications:",t)}}();this.store=e.store,this.displayNotifications(this.store),this.unread=e.unread,this.handleUnread(this.unread),this.refresh>1&&!document.querySelector(`[data-notif-id="${this.store.at(-1).text.id}"]`)&&this.liveNotif(t.timeout?t.timeout:5e3,this.store.at(-1))}}))},liveNotif:async function(t,e){const{from:n,type:a}=e.text;let s="",c=Toolbar.compileNotif(e);if(n){const t=await o(n);s=t.avatar,c=i(e,t.color)}const l=L("live_notif",{live:{type:this.type[a].name,icon:this.type[a].icon,avatar:14===a?r(e):s,text:c}}),u=(new DOMParser).parseFromString(l,"text/html").body.firstChild;document.body.appendChild(u),u.getBoundingClientRect(),requestAnimationFrame((()=>{u.classList.add("up")})),setTimeout((()=>{u.classList.remove("up"),setTimeout((()=>u.remove()),1e3)}),t),document.body.addEventListener("click",(t=>{t.target.closest("#alert_dismiss")&&(u.classList.remove("up"),setTimeout((()=>u.remove()),1e3))}))},renderNotif:async function(e){let n=[];for(const a of e){const{id:e,from:s,type:c}=a.text;let l="",u=Toolbar.compileNotif(a);if(s){const t=await o(s);l=t.avatar,u=i(a,t.color)}n.push({id:e,read:a.read?"":"unread",type:this.type[c].name,...!this.disableIcon&&{icon:this.type[c].icon},avatar:14===c?r(a):l,text:u,time:a.time,async deleteNotif(e){const n=e.target.closest("[data-notif-id]").dataset.notifId,o=await t(n,this.channel);P.store=o,P.displayNotifications(),P.handleUnread()}})}return n.reverse()},displayNotifications:async function(){0===this.store.length?(this.syncStore.notifs=[],this.syncStore.isEmpty=!0):(this.syncStore.notifs=await this.renderNotif(this.store),this.syncStore.isEmpty=!1)},manageNotifications:function(){const t={deleteAll:document.querySelector("#notiffi_delete_all"),markAllRead:document.querySelector("#notiffi_mark_as_read")};for(const o in t){const i=t[o];if(!i)return void console.error(`NOTIFFI: Le bouton ${o} est introuvable.`);const r={deleteAll:async()=>{const t=this.store.map((t=>t.text.id));if(await e(t)){for(;this.store.length>0;)this.store.pop();this.displayNotifications(),this.handleUnread()}},markAllRead:async()=>{const t=this.store.filter((t=>!t.read)).map((t=>t.text.id));await n(t)&&this.handleUnread()}};i.addEventListener("click",r[o])}},handleUnread:function(){const t=this.store.filter((t=>!t.read)).length;this.unread=t,this.syncUnread.count=t?this.unread:""},interceptMethodCalls:function(t,e){return new Proxy(t,{get:(t,n)=>"function"==typeof t[n]?new Proxy(t[n],{apply:(t,o,i)=>(e(n,i),Reflect.apply(t,o,i))}):Reflect.get(t,n)})}};return P}();
